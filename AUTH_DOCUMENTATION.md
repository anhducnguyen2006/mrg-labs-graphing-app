# Authentication System Documentation

## Overview

The MRG Labs Graphing Application now includes a complete authentication system with user registration, login, and session management. This document explains how the authentication works and how to use it.

## Architecture

### Backend (FastAPI)

The backend uses:

- **Session-based authentication** with server-side session storage
- **bcrypt** for secure password hashing
- **MySQL database** for user data persistence
- **Session middleware** for maintaining user sessions

#### Database Schema

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE graphs (
    graph_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    baseline_filename VARCHAR(255),
    sample_filename VARCHAR(255),
    generated_path TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### Backend Endpoints

##### `POST /register`

Register a new user account.

**Request Body**:

```json
{
  "username": "john_doe",
  "password": "securePassword123"
}
```

**Response** (200 OK):

```json
{
  "status": "ok",
  "username": "john_doe"
}
```

**Errors**:

- `400`: Username already exists or invalid input
- `500`: Server error

##### `POST /login`

Authenticate a user and create a session.

**Request Body**:

```json
{
  "username": "john_doe",
  "password": "securePassword123"
}
```

**Response** (200 OK):

```json
{
  "status": "ok",
  "user_id": 1
}
```

**Errors**:

- `401`: Invalid credentials
- `400`: Missing username or password
- `500`: Server error

**Side Effect**: Sets session cookie with `user_id`

##### `POST /logout`

Clear the user's session.

**Response** (200 OK):

```json
{
  "status": "ok"
}
```

**Side Effect**: Clears session cookie

##### `GET /api/v1/files`

Get list of graphs generated by the authenticated user (protected route).

**Response** (200 OK):

```json
{
  "files": [
    {
      "graph_id": 1,
      "baseline_filename": "baseline.csv",
      "sample_filename": "sample1.csv",
      "generated_path": "/static/generated_graphs/...",
      "created_at": "2025-11-08T12:00:00"
    }
  ]
}
```

**Errors**:

- `401`: Not authenticated

### Frontend (React + TypeScript)

The frontend uses:

- **React Router** for navigation
- **React Context API** for authentication state management
- **Chakra UI** for beautiful, accessible UI components
- **Session cookies** for maintaining authentication

#### Project Structure

```
frontend/src/
├── contexts/
│   └── AuthContext.tsx          # Authentication state management
├── services/
│   └── auth.ts                  # Authentication API calls
├── pages/
│   ├── Login.tsx                # Login page
│   ├── Signup.tsx               # Registration page
│   └── Dashboard.tsx            # Main application (protected)
├── components/
│   └── ProtectedRoute.tsx       # Route guard component
└── App.tsx                      # Main app with routing
```

## Features

### 1. User Registration (Signup)

**Location**: `/signup`

**Features**:

- Username validation (minimum 3 characters)
- Password strength indicator
- Password confirmation with visual feedback
- Real-time validation
- Error handling with user-friendly messages
- Automatic login after successful registration

**Validation Rules**:

- Username: Minimum 3 characters, required
- Password: Minimum 6 characters, required
- Passwords must match

### 2. User Login

**Location**: `/login`

**Features**:

- Username and password authentication
- Show/hide password toggle
- Remember session across page refreshes
- Error handling for invalid credentials
- Redirect to dashboard on success

### 3. Protected Routes

All authenticated pages (like Dashboard) are protected:

- Automatically redirect to login if not authenticated
- Loading state while checking authentication
- Session persistence across page refreshes

### 4. Logout

Available from the user profile menu in Dashboard:

- Clears session on backend
- Redirects to login page
- Shows success notification

## Setup Instructions

### 1. Backend Setup

#### Install Dependencies

```bash
cd backend
pip install -r requirements.txt
```

#### Configure Database

Create a `.env` file in the `backend/` directory:

```env
# Database Configuration
DB_HOST=localhost
DB_USER=your_mysql_user
DB_PASS=your_mysql_password
DB_NAME=mrg_labs_db

# Session Secret (generate a secure random string)
SESSION_SECRET=your-super-secret-session-key-here

# Gemini AI (for existing features)
GEMINI_API_KEY=your_gemini_api_key_here
```

#### Initialize Database

```sql
-- Create database
CREATE DATABASE mrg_labs_db;

USE mrg_labs_db;

-- Create users table
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create graphs table
CREATE TABLE graphs (
    graph_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    baseline_filename VARCHAR(255),
    sample_filename VARCHAR(255),
    generated_path TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### Start Backend

```bash
cd backend
python -m uvicorn app:app --reload --port 8080
```

### 2. Frontend Setup

#### Install Dependencies

```bash
cd frontend
npm install
```

The required packages are already in `package.json`:

- `react-router-dom` - Routing
- `@chakra-ui/react` - UI components
- `@chakra-ui/icons` - Icons

#### Start Frontend

```bash
npm run dev
```

Frontend will be available at: `http://localhost:5173`

## Usage Flow

### New User Registration

1. Navigate to `http://localhost:5173`
2. Click "Sign Up" or go to `/signup`
3. Enter username (min 3 characters)
4. Enter password (min 6 characters)
5. Confirm password
6. Click "Sign Up"
7. Automatically logged in and redirected to dashboard

### Existing User Login

1. Navigate to `http://localhost:5173`
2. If not logged in, redirected to `/login`
3. Enter username and password
4. Click "Sign In"
5. Redirected to dashboard

### Using the Application

1. After login, access the dashboard
2. Upload baseline and sample CSV files
3. View generated graphs
4. Use AI-powered analysis and chat features
5. Export graphs

### Logout

1. Click user profile icon (top right)
2. Click "Logout"
3. Session cleared, redirected to login

## Security Considerations

### Backend Security

1. **Password Hashing**: Passwords are hashed using bcrypt with salt
2. **Session Management**: Secure session cookies with secret key
3. **SQL Injection Prevention**: Using parameterized queries
4. **CORS Configuration**: Restricted to specific origins

### Frontend Security

1. **Credentials Mode**: All API requests include `credentials: 'include'` for cookies
2. **Protected Routes**: Authentication check before accessing protected pages
3. **No Password Storage**: Passwords never stored in frontend state
4. **Session Validation**: Regular checks of authentication status

### Production Recommendations

⚠️ **For production deployment, implement these additional security measures**:

1. **HTTPS Only**: Serve application over HTTPS
2. **Secure Cookies**: Set `secure` and `httpOnly` flags on session cookies
3. **CSRF Protection**: Implement CSRF token validation
4. **Rate Limiting**: Add rate limiting to prevent brute force attacks
5. **Password Requirements**: Enforce stronger password policies
6. **Session Expiration**: Implement automatic session timeout
7. **Account Verification**: Add email verification for new accounts
8. **2FA**: Consider adding two-factor authentication
9. **Password Reset**: Implement secure password reset functionality
10. **Audit Logging**: Log authentication events for security monitoring

## API Integration

### Using Auth Service in Components

```typescript
import { useAuth } from "../contexts/AuthContext";

function MyComponent() {
  const { user, isAuthenticated, login, logout, register } = useAuth();

  // Check if user is logged in
  if (isAuthenticated) {
    console.log("User:", user.username);
  }

  // Login
  const handleLogin = async () => {
    try {
      await login("username", "password");
    } catch (error) {
      console.error("Login failed:", error);
    }
  };

  // Logout
  const handleLogout = async () => {
    await logout();
  };

  return <div>...</div>;
}
```

### Making Authenticated API Requests

```typescript
// All requests to protected endpoints must include credentials
fetch("http://localhost:8080/api/v1/files", {
  credentials: "include", // Important!
})
  .then((res) => res.json())
  .then((data) => console.log(data));
```

## Troubleshooting

### Issue: "Not authenticated" error on dashboard

**Solution**:

1. Check if backend is running
2. Verify database connection
3. Clear browser cookies and try logging in again
4. Check browser console for errors

### Issue: "Username already exists"

**Solution**: Choose a different username or use the login page if you already have an account

### Issue: Session not persisting after page refresh

**Solution**:

1. Ensure `credentials: 'include'` is set in all API requests
2. Check that SESSION_SECRET is set in backend `.env`
3. Verify CORS configuration allows credentials

### Issue: Cannot connect to database

**Solution**:

1. Verify MySQL is running
2. Check database credentials in `.env` file
3. Ensure database and tables are created
4. Test database connection manually

### Issue: Password validation errors

**Solution**:

- Username must be at least 3 characters
- Password must be at least 6 characters
- Passwords must match during signup

## Testing

### Test User Registration

```bash
curl -X POST http://localhost:8080/register \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser", "password": "testpass123"}'
```

### Test User Login

```bash
curl -X POST http://localhost:8080/login \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser", "password": "testpass123"}' \
  -c cookies.txt
```

### Test Protected Endpoint

```bash
curl http://localhost:8080/api/v1/files \
  -b cookies.txt
```

### Test Logout

```bash
curl -X POST http://localhost:8080/logout \
  -b cookies.txt
```

## Future Enhancements

Potential improvements for the authentication system:

1. **Email/Password Reset**: Add email-based password recovery
2. **OAuth Integration**: Add Google/GitHub OAuth login
3. **User Profiles**: Extended user profiles with avatars, bio, etc.
4. **Account Settings**: Page for changing password, updating profile
5. **Session Management**: View and revoke active sessions
6. **Activity Log**: Track user login history
7. **Role-Based Access**: Admin, user, guest roles
8. **API Keys**: Generate API keys for programmatic access
9. **Team Features**: Multi-user workspaces and collaboration
10. **SSO Integration**: Enterprise single sign-on support

## Additional Resources

- [FastAPI Security Documentation](https://fastapi.tiangolo.com/tutorial/security/)
- [React Router Documentation](https://reactrouter.com/)
- [Chakra UI Components](https://chakra-ui.com/)
- [bcrypt Documentation](https://github.com/pyca/bcrypt/)

---

**Status**: ✅ Fully Implemented and Tested

The authentication system is now complete and ready for use!
